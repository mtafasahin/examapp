<div class="container" [ngClass]="selectionMode()">
  <div class="form-container">
    <div class="form-column-4" style="border: var(--border-input)">
      <ng-container *ngIf="previewMode()">
        <div class="form-container" style="border: var(--border-input)">
          <app-question-navigator
            class="form-column"
            [questions]="previewQuestions"
            (questionSelected)="questionSelected($event)"
          ></app-question-navigator>

          <app-question-canvas-view
            class="form-column-4"
            [questionRegion]="regions()[previewCurrentIndex()]"
            [currentClassification]="currentClassification()"
            [isPreviewMode]="true"
            (choiceSelected)="onPreviewChoiceSelected($event)"
            (questionRemove)="onQuestionRemove($event)"
            (applyClassification)="onApplyClassification($event)"
          ></app-question-canvas-view>

          <!-- Classification Selector for Preview Mode -->
          <app-classification-selector
            class="form-column-2"
            [initialSelection]="currentClassification()"
            (selectionChange)="onClassificationChange($event)"
          ></app-classification-selector>
        </div>
      </ng-container>

      <div *ngIf="!previewMode() && imageSrc()" class="ms-canvas-wrapper">
        <canvas
          #canvas
          (mousedown)="startSelection($event)"
          (click)="tapCorrectAnswer($event)"
          (mousemove)="onMouseMove($event)"
          (mouseup)="endSelection($event)"
          (contextmenu)="onRightClick($event)"
        ></canvas>
        <!-- Sol bÃ¶lge â€“ Previous -->
        <div class="ms-nav-area ms-nav-prev" [class.ms-nav-disabled]="isDrawing" (click)="previousImage()"></div>
        <!-- SaÄŸ bÃ¶lge â€“ Next -->
        <div class="ms-nav-area ms-nav-next" [class.ms-nav-disabled]="isDrawing" (click)="nextImage()"></div>
        <!-- Marker'lar -->
        <div
          *ngFor="let marker of warningMarkers"
          [class.cs-warning-marker]="marker.type === 'warning'"
          [class.cs-error-marker]="marker.type === 'error'"
          [ngStyle]="{ top: marker.y + 'px', left: marker.x + 'px' }"
          (click)="openWarningContextMenu(marker, $event)"
        >
          <mat-icon
            [style.width]="warningIconHeight + 'px !important'"
            [style.height]="warningIconHeight + 'px !important'"
            [style.font-size]="warningIconHeight + 'px !important'"
            color="warn"
            >warning</mat-icon
          >
        </div>
        <!-- Marker context menÃ¼ -->
        <div
          *ngIf="warningMenuVisible"
          class="wr-custom-context-menu"
          [ngStyle]="{ top: warningMenuY + 'px', left: warningMenuX + 'px' }"
          (click)="$event.stopPropagation()"
        >
          <div style="padding: 8px; max-width: 220px">
            <!-- <strong>UyarÄ±:</strong> -->
            <ul>
              <li *ngFor="let warningMessage of selectedWarning?.messages">
                <div>{{ warningMessage }}</div>
              </li>
            </ul>
          </div>
          <mat-divider></mat-divider>
          <button (click)="dismissWarning($event)">UyarÄ±yÄ± Kapat</button>
        </div>
      </div>

      <div
        *ngIf="contextMenuVisible"
        (click)="$event.stopPropagation()"
        class="ms-custom-context-menu"
        [ngStyle]="{ top: contextMenuY + 'px', left: contextMenuX + 'px' }"
      >
        <!-- Region iÃ§in menÃ¼ -->
        <ng-container *ngIf="contextMenuType === 'region'">
          <button (click)="handleMenuAction('removeQuestion', $event)">
            <mat-icon style="vertical-align: middle; margin-right: 8px">delete</mat-icon>
            Soru Sil
          </button>
          <button (click)="handleMenuAction('selectAnswerMode', $event)">
            <mat-icon style="vertical-align: middle; margin-right: 8px">crop_square</mat-icon>
            ÅÄ±k Ã‡iz (MCQ)
          </button>
          <button (click)="handleMenuAction('selectDropZoneMode', $event)">
            <mat-icon style="vertical-align: middle; margin-right: 8px">radio_button_unchecked</mat-icon>
            Zone Ã‡iz (dragDropLabeling)
          </button>

          <!-- dragDropLabeling hÄ±zlÄ± ayarlarÄ± (saÄŸ panel olmadan) -->
          <ng-container
            *ngIf="
              selectedRegion! >= 0 && getInteractionType(regions()[selectedRegion || 0].name) === 'dragDropLabeling'
            "
          >
            <mat-divider></mat-divider>
            <div style="padding: 6px 8px; font-size: 12px; opacity: 0.8">dragDropLabeling</div>

            <label style="display: block; padding: 6px 8px 2px; font-size: 12px; opacity: 0.8">Etiket SayÄ±sÄ±</label>
            <input
              type="number"
              min="1"
              max="30"
              style="margin: 0 8px 6px; width: calc(100% - 16px)"
              [value]="getLabelCount(regions()[selectedRegion || 0].name)"
              (click)="$event.stopPropagation()"
              (change)="setLabelCount(regions()[selectedRegion || 0].name, $any($event.target).value)"
            />

            <button (click)="ensureDraggables(regions()[selectedRegion || 0].name)">
              <mat-icon style="vertical-align: middle; margin-right: 8px">format_list_numbered</mat-icon>
              Etiketleri OluÅŸtur
            </button>
            <button (click)="autoAssignSolutionSequential(regions()[selectedRegion || 0].name)">
              <mat-icon style="vertical-align: middle; margin-right: 8px">auto_fix_high</mat-icon>
              Auto Solution
            </button>
          </ng-container>

          <button (click)="handleMenuAction('removeAll', $event)">
            <mat-icon style="vertical-align: middle; margin-right: 8px">delete</mat-icon>
            TÃ¼m SorularÄ± Sil
          </button>
          <button (click)="handleMenuAction('alignAnswers', $event)">
            <mat-icon style="vertical-align: middle; margin-right: 8px">format_align_center</mat-icon>
            CevaplarÄ± Hizala
          </button>
          <select
            *ngIf="selectedRegion! >= 0 && passages().length > 0"
            id="passageSelect"
            (change)="onPassageChange($event, regions()[selectedRegion || 0].name)"
            (click)="$event.stopPropagation()"
          >
            <option value="0" [selected]="!selectedPassageMap.has(regions()[selectedRegion || 0].name)">
              ğŸ”¹ Passage SeÃ§iniz
            </option>
            <option
              *ngFor="let passage of passages()"
              [value]="passage.id"
              [selected]="selectedPassageMap.get(regions()[selectedRegion || 0].name) === passage.id"
            >
              Passage {{ passage.id }}
            </option>
          </select>
        </ng-container>

        <!-- Answer iÃ§in menÃ¼ -->
        <ng-container *ngIf="contextMenuType === 'answer'">
          <button (click)="handleMenuAction('removeAnswer', $event)">
            <mat-icon style="vertical-align: middle; margin-right: 8px">delete</mat-icon>SeÃ§eneÄŸi Sil
          </button>
        </ng-container>

        <!-- DropZone iÃ§in menÃ¼ -->
        <ng-container *ngIf="contextMenuType === 'dropzone'">
          <ng-container *ngIf="selectedRegion! >= 0 && selectedDropZoneId as zoneId">
            <div style="padding: 6px 8px; font-size: 12px; opacity: 0.8">Zone: {{ zoneId }}</div>

            <label style="display: block; padding: 6px 8px 2px; font-size: 12px; opacity: 0.8">Etiket SayÄ±sÄ±</label>
            <input
              type="number"
              min="1"
              max="30"
              style="margin: 0 8px 6px; width: calc(100% - 16px)"
              [value]="getLabelCount(regions()[selectedRegion || 0].name)"
              (click)="$event.stopPropagation()"
              (change)="setLabelCount(regions()[selectedRegion || 0].name, $any($event.target).value)"
            />

            <button (click)="ensureDraggables(regions()[selectedRegion || 0].name)">
              <mat-icon style="vertical-align: middle; margin-right: 8px">format_list_numbered</mat-icon>
              Etiketleri OluÅŸtur
            </button>

            <label style="display: block; padding: 6px 8px 2px; font-size: 12px; opacity: 0.8">DoÄŸru Etiket</label>
            <select
              (click)="$event.stopPropagation()"
              [value]="getZoneAssignedDraggable(regions()[selectedRegion || 0].name, zoneId)"
              (change)="setZoneSolutionFromMenu(regions()[selectedRegion || 0].name, zoneId, $any($event.target).value)"
            >
              <option value="0">(boÅŸ)</option>
              <option *ngFor="let d of getDraggables(regions()[selectedRegion || 0].name)" [value]="d.id">
                {{ d.label }}
              </option>
            </select>

            <button (click)="handleMenuAction('removeDropZone', $event)">
              <mat-icon style="vertical-align: middle; margin-right: 8px">delete</mat-icon>
              Zone Sil
            </button>
          </ng-container>
        </ng-container>

        <!-- Passage iÃ§in menÃ¼ -->
        <ng-container *ngIf="contextMenuType === 'passage'">
          <div style="padding: 6px 8px; font-size: 12px; opacity: 0.8">Passage: {{ selectedPassageId }}</div>
          <button (click)="handleMenuAction('toggleShowPassageFirst', $event)">
            <mat-icon style="vertical-align: middle; margin-right: 8px">
              {{ isPassageFirstEnabledForPassage(selectedPassageId) ? 'visibility_off' : 'view_agenda' }}
            </mat-icon>
            {{ isPassageFirstEnabledForPassage(selectedPassageId) ? 'Passage Ã¶nce Ã§Ä±kmasÄ±n' : 'Passage Ã¶nce Ã§Ä±ksÄ±n' }}
          </button>
          <button (click)="handleMenuAction('removePassage', $event)">
            <mat-icon style="vertical-align: middle; margin-right: 8px">delete</mat-icon>
            Passage Sil
          </button>
        </ng-container>

        <!-- Answer iÃ§in menÃ¼ -->
        <ng-container *ngIf="contextMenuType === 'worksheet'">
          <button (click)="handleMenuAction('selectQuestion', $event)">
            <mat-icon style="vertical-align: middle; margin-right: 8px">help_outline</mat-icon>
            Soru SeÃ§
          </button>
          <button (click)="handleMenuAction('predict', $event)">
            <mat-icon style="vertical-align: middle; margin-right: 8px">smart_toy</mat-icon>
            Yapay Zekaya Sor
          </button>
          <button (click)="handleMenuAction('selectPassage', $event)">
            <mat-icon style="vertical-align: middle; margin-right: 8px">assignment</mat-icon>Pasaj SeÃ§
          </button>
        </ng-container>
      </div>
    </div>
    <div style="max-width: 250px">
      <!-- <input type="file" (change)="handleFilesInput2($event)" multiple accept="image/*"> -->
      {{ imagName() }}

      <div style="margin: 8px 0">
        <button mat-button (click)="toggleShowRegions()">
          {{ showRegions() ? 'SaÄŸ Paneli Gizle' : 'SaÄŸ Paneli GÃ¶ster' }}
        </button>
      </div>

      <div *ngIf="showRegions()" class="regions-list">
        <h3>SeÃ§ilen BÃ¶lgeler:</h3>
        <ul class="regions">
          <li *ngFor="let region of regions(); let i = index">
            <!-- <quill-editor *ngIf="isExample(region.name)" [ngModel]="exampleAnswers.get(region.name)" (ngModelChange)="onTextChanged(region.name, $event)">
          </quill-editor> -->
            <div class="flex-no-wrap border-none" style="margin: 6px 0">
              <label style="display: block; font-size: 12px; opacity: 0.8">Interaction Type</label>
              <select (change)="onInteractionTypeChange($event, region.name)">
                <option value="mcq" [selected]="getInteractionType(region.name) === 'mcq'">MCQ</option>
                <option value="dragDropLabeling" [selected]="getInteractionType(region.name) === 'dragDropLabeling'">
                  dragDropLabeling
                </option>
              </select>
            </div>

            <ul *ngIf="!onlyQuestionMode() && getInteractionType(region.name) !== 'dragDropLabeling'">
              <li class="flex-no-wrap border-none" *ngFor="let answer of region.answers; let j = index">
                <button class="choice-btn" (click)="setCorrectAnswer(i, j, 1)">
                  {{ answer.label }} {{ answer.isCorrect ? 'âœ…' : '' }}
                </button>
                <button (click)="removeAnswer(i, j)">âŒ</button>
              </li>
            </ul>

            <div *ngIf="getInteractionType(region.name) === 'dragDropLabeling'" style="margin: 8px 0">
              <div class="flex-no-wrap border-none" style="gap: 8px; align-items: center">
                <button (click)="selectDropZoneMode(i)">ğŸŸ§ Drop Zone Ã‡iz</button>
                <button (click)="removeLastDropZone(region.name)">â†©ï¸ Son Zone</button>
                <button (click)="clearDropZones(region.name)">ğŸ—‘ Zone Temizle</button>
                <label style="font-size: 12px; opacity: 0.8">Etiket SayÄ±sÄ±</label>
                <input
                  type="number"
                  min="1"
                  max="30"
                  [value]="getLabelCount(region.name)"
                  (change)="setLabelCount(region.name, $any($event.target).value)"
                  style="width: 70px"
                />
                <button (click)="generateDraggables(region.name)">Etiketleri OluÅŸtur</button>
                <button (click)="autoAssignSolutionSequential(region.name)">Auto Solution</button>
              </div>

              <div style="margin-top: 8px">
                <div style="font-size: 12px; opacity: 0.8; margin-bottom: 4px">Solution (DropZone â†’ Etiket)</div>
                <div *ngFor="let z of getDropZones(region.name)" class="flex-no-wrap border-none" style="gap: 8px">
                  <span style="min-width: 38px">{{ z.id }}</span>
                  <select
                    [value]="getZoneAssignedDraggable(region.name, z.id)"
                    (change)="setZoneSolution(region.name, z.id, $any($event.target).value)"
                  >
                    <option value="0">(boÅŸ)</option>
                    <option *ngFor="let d of getDraggables(region.name)" [value]="d.id">{{ d.label }}</option>
                  </select>
                </div>
              </div>
            </div>
            <ul>
              <li class="flex-no-wrap border-none">
                <button (click)="removeQuestion(i)">âŒ Soru Sil</button>
              </li>
              <li class="flex-no-wrap border-none">
                <button (click)="selectQuestion(i)" [disabled]="isExample(region.name)">ÅÄ±k SeÃ§</button>
              </li>
              <li class="flex-no-wrap border-none">
                <button (click)="alignAnswers(i)" [disabled]="region.answers.length < 2">ğŸ”„ Hizala</button>
              </li>
              <li class="flex-no-wrap border-none">
                <select id="passageSelect" class="passage-select" (change)="onPassageChange($event, region.name)">
                  <option value="0" [selected]="!selectedPassageMap.has(region.name)">Passage SeÃ§iniz</option>
                  <option
                    *ngFor="let passage of passages()"
                    [value]="passage.id"
                    [selected]="selectedPassageMap.get(region.name) === passage.id"
                  >
                    Passage {{ passage.id }}
                  </option>
                </select>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>
